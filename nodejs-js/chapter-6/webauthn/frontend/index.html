<html>
  <head>
    <script src="/js-base64/base64.js"></script>
    <script>
      async function register(){
        username = document.getElementById("ruser").value;
        const state = crypto.randomUUID();
        const uri = `/webauthn/register/begin?username=${username}&state=${state}`;
        const encodedUri = encodeURI(uri);
        const res = await fetch(encodedUri, {
          method: "POST",
          headers: {
            "Accept": "application/json"
          },
        });

        if (res.ok){
          const publicKey = await res.json();
          publicKey.challenge = Base64.toUint8Array(publicKey.challenge);
          const textEncoder = new TextEncoder();
          publicKey.user.id = textEncoder.encode(publicKey.user.id);

          const cred = await window.navigator.credentials.create({publicKey});

          const attestationObject = Base64.fromUint8Array(new Uint8Array(cred.response.attestationObject), true);
          const clientDataJSON = Base64.fromUint8Array(new Uint8Array(cred.response.clientDataJSON), true);

          const cc = {
            id: Base64.encodeURI(cred.id),
            rawId: Base64.fromUint8Array(new Uint8Array(cred.rawId), true),
            response: {attestationObject, clientDataJSON},
            type: 'public-key'
          };

          const uri2 = `/webauthn/register/finish?username=${username}&state=${state}`;
          const encodedUri = encodeURI(uri2);
          const res2 = await fetch(encodedUri, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Accept": "application/json"
            },
            body: JSON.stringify(cc)
          });
          const val = await res2.json();
          document.getElementById("rstatus").innerText = res2.ok ? val.success : val.error;
        } else {
          const val = await res.json();
          document.getElementById("rstatus").innerText = val.error;
        }
      }
      
      async function validate(){
        username = document.getElementById("vuser").value;
        const state = crypto.randomUUID();
        const uri = `/webauthn/login/begin?username=${username}&state=${state}`;
        const encodedUri = encodeURI(uri);
        const res = await fetch(encodedUri, {
          method: "POST",
          headers: {
            "Accept": "application/json"
          },
        });

        if (res.ok){
          const publicKey = await res.json();
          publicKey.challenge = Base64.toUint8Array(publicKey.challenge);
          const id = publicKey.allowCredentials[0].id;
          publicKey.allowCredentials[0].id = Base64.toUint8Array(id); 

          console.log("PublicKey:", publicKey);

          const cred = await window.navigator.credentials.get({publicKey});
          console.log(cred);

          const authenticatorData = Base64.fromUint8Array(new Uint8Array(cred.response.authenticatorData), true);
          const clientDataJSON = Base64.fromUint8Array(new Uint8Array(cred.response.clientDataJSON), true);
          const signature = Base64.fromUint8Array(new Uint8Array(cred.response.signature), true);

          const cc = {
            id: Base64.encodeURI(cred.id),
            rawId: Base64.fromUint8Array(new Uint8Array(cred.rawId), true),
            response: {authenticatorData, clientDataJSON, signature},
            type: 'public-key'
          };

          const uri2 = `/webauthn/login/finish?username=${username}&state=${state}`;
          const encodedUri = encodeURI(uri2);
          const res2 = await fetch(encodedUri, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Accept": "application/json"
            },
            body: JSON.stringify(cc)
          });
          const val = await res2.json();
          document.getElementById("vstatus").innerText = res2.ok ? val.success : val.error;
        } else {
          const val = await res.json();
          document.getElementById("vstatus").innerText = val.error;
        }
      }
    </script>
  </head>
  <body>
    <h1 align="center">WebAuthn Demo Page</h1>
    <table width="100%">
      <tr><td align="center"><b>Registration View</b></td><td align="center"><b>Authentication View</b></td></tr>
      <tr>
        <td align="center"><input id="ruser" type="text" value="alice" disabled/></td>
        <td align="center"><input id="vuser" type="text" value="alice" disabled/></td>
      </tr>
      <tr>
        <td align="center"><button id="register" type="button" onclick="register();">Register</button></td>
        <td align="center"><button id="validate" type="button" onclick="validate()">Validate</button></td>
      </tr>
      <tr>
        <td id="rstatus" align="center">Register the user.</td>
        <td id="vstatus" align="center">Authenticate the user.</td>
      </tr>
    </table>
  </body>
</html>